<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - BotEngine</title>
    <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #f8fafc;
        }
        
        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(14, 165, 233, 0.3);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
            border-color: transparent;
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.4);
        }
        
        .btn-secondary {
            background: transparent;
            border-color: rgba(148, 163, 184, 0.3);
            color: #cbd5e1;
        }
        
        .btn-secondary:hover {
            border-color: #0ea5e9;
            color: #0ea5e9;
        }
        
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 40px;
        }
        
        .section {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(14, 165, 233, 0.2);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #0ea5e9;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .save-notification {
            position: fixed;
            top: 100px;
            right: 40px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .price-item {
            background: rgba(15, 23, 42, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            margin-bottom: 15px;
        }
        
        .price-item h4 {
            color: #0ea5e9;
            margin-bottom: 10px;
        }
        
        .product-card {
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            border-color: rgba(14, 165, 233, 0.5);
            background: rgba(15, 23, 42, 0.8);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
        }

        .product-card-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .product-card-image {
            width: 100%;
            height: 180px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-card-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .order-card {
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .order-email {
            color: #0ea5e9;
            font-weight: 600;
        }

        .order-date {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .order-total {
            color: #10b981;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .order-items {
            margin-top: 15px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #cbd5e1;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .product-card h3 {
            color: #0ea5e9;
            margin: 0;
        }
        
        .product-card-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.3s ease;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid rgba(14, 165, 233, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #0ea5e9;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #cbd5e1;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: #0ea5e9;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .container {
                padding: 0 20px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Panel de Administraci√≥n</h1>
        <div class="header-actions">
            <button class="btn btn-primary" id="saveAllBtn">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-eye"></i> Ver Sitio
            </a>
            <button class="btn btn-secondary" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
            </button>
        </div>
    </div>
    
    <div class="save-notification" id="saveNotification">
        <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
        <span>Cambios guardados exitosamente</span>
    </div>
    
    <!-- Modal para agregar/editar productos -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuevo Producto</h2>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Nombre del Producto *</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">Descripci√≥n *</label>
                    <textarea id="productDescription" required></textarea>
                </div>

                <!-- Calculadora de Precios -->
                <div style="background: rgba(14, 165, 233, 0.1); border: 2px solid rgba(14, 165, 233, 0.3); border-radius: 10px; padding: 16px; margin: 20px 0;">
                    <h3 style="margin: 0 0 16px 0; color: #0ea5e9; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-calculator"></i> Calculadora de Precios
                    </h3>
                    
                    <div class="form-group">
                        <label for="productCost">Costo Estimado (Q) *</label>
                        <input type="number" id="productCost" min="0" step="0.01" placeholder="ej: 120" required>
                        <small style="color: #94a3b8;">Costo total puesto en tus manos</small>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label>Margen Deseado (%)</label>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="margin-btn" data-margin="50">50%</button>
                                <button type="button" class="margin-btn" data-margin="55">55%</button>
                            </div>
                        </div>
                        <div>
                            <label>O Ingresa Manual</label>
                            <input type="number" id="productMargin" min="0" max="100" step="1" placeholder="50" value="50" style="padding: 8px; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #cbd5e1; background: rgba(15, 23, 42, 0.4);">
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.6); padding: 12px; border-radius: 6px; margin-top: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem;">
                            <div>
                                <span style="color: #94a3b8;">Ganancia Bruta:</span><br>
                                <span style="color: #10b981; font-weight: bold; font-size: 1.1rem;" id="gananciaDisplay">Q 0.00</span>
                            </div>
                            <div>
                                <span style="color: #94a3b8;">Margen Real:</span><br>
                                <span style="color: #10b981; font-weight: bold; font-size: 1.1rem;" id="margenRealDisplay">0%</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <span style="color: #94a3b8;">Precio de Venta Recomendado:</span><br>
                            <span style="color: #0ea5e9; font-weight: bold; font-size: 1.3rem;" id="precioRecomendado">Q 0.00</span>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.2); background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 4px;">
                            <span style="color: #94a3b8; font-size: 0.85rem;">Ganancia Total (despu√©s de descuentos):</span><br>
                            <span style="color: #22c55e; font-weight: bold; font-size: 1.2rem;" id="gananciaTotal">Q 0.00</span>
                            <br><span style="color: #a1a1a1; font-size: 0.75rem; margin-top: 4px; display: block;">-4.83% Paggo | -Q15 Env√≠o</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productPrice">Precio de Venta Final (Q) *</label>
                    <input type="number" id="productPrice" min="0" step="0.01" required>
                    <small style="color: #94a3b8;">Este ser√° el precio que se mostrar√° en la tienda</small>
                    
                    <!-- Botones para agregar costos -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
                        <button type="button" id="btnAgregarPaggo" style="padding: 10px; background: linear-gradient(135deg, #f97316, #ea580c); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">
                            + Comisi√≥n Paggo (4.83%)
                        </button>
                        <button type="button" id="btnAgregarEnvio" style="padding: 10px; background: linear-gradient(135deg, #06b6d4, #0891b2); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">
                            + Env√≠o (Q15)
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productStock">Stock Disponible *</label>
                    <input type="number" id="productStock" min="0" required>
                </div>
                <div class="form-group">
                    <label for="productStatus">Estado del Producto *</label>
                    <select id="productStatus" required style="padding: 10px; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #cbd5e1; background: rgba(15, 23, 42, 0.4);">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                        <option value="agotado">Agotado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productImage">Imagen del Producto *</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="file" id="productImage" accept="image/*" style="flex: 1; padding: 10px; border: 2px solid rgba(148, 163, 184, 0.2); border-radius: 10px; color: #cbd5e1;">
                        <button type="button" class="btn btn-secondary" data-action="clear-image" style="padding: 8px 16px;">Limpiar</button>
                    </div>
                    <div id="imagePreview" style="width: 100%; height: 150px; background: rgba(15, 23, 42, 0.6); border: 2px dashed rgba(148, 163, 184, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.9rem;">
                        Preview de la imagen
                    </div>
                </div>
                <div class="form-group">
                    <label for="productCategory">Categor√≠a *</label>
                    <input type="text" id="productCategory" placeholder="ej: Combos, Accesorios" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Producto
                    </button>
                    <button type="button" class="btn btn-secondary" data-action="close-modal" style="flex: 1;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <style>
        .margin-btn {
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.5);
            color: #0ea5e9;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .margin-btn:hover {
            background: rgba(14, 165, 233, 0.4);
        }
        
        .margin-btn.active {
            background: rgba(14, 165, 233, 0.8);
        }
    </style>
    
    <div class="save-notification" id="saveNotification">
        <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
        <span>Cambios guardados exitosamente</span>
    </div>
    
    <!-- Tabs de navegaci√≥n -->
    <div style="background: rgba(30, 41, 59, 0.9); border-bottom: 2px solid rgba(14, 165, 233, 0.2); padding: 0 40px; display: flex; gap: 30px; margin-top: 20px;">
        <button class="tab-btn active" data-tab="frontal">
            <i class="fas fa-home"></i> Frontal
        </button>
        <button class="tab-btn" data-tab="tienda">
            <i class="fas fa-store"></i> Tienda
        </button>
        <button class="tab-btn" data-tab="cupones">
            <i class="fas fa-ticket-alt"></i> Cupones
        </button>
    </div>
    
    <style>
        .tab-btn {
            background: transparent;
            border: none;
            color: #cbd5e1;
            padding: 20px 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn:hover {
            color: #0ea5e9;
        }
        
        .tab-btn.active {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
    
    <div class="container">
        <!-- TAB FRONTAL -->
        <div class="tab-content active" id="tab-frontal">
            <!-- Informaci√≥n Principal -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-info-circle"></i>
                Informaci√≥n Principal
            </h2>
            <div class="grid">
                <div class="form-group">
                    <label for="siteName">Nombre del Sitio</label>
                    <input type="text" id="siteName" value="BotEngine">
                </div>
                <div class="form-group">
                    <label for="siteTagline">Eslogan Principal</label>
                    <input type="text" id="siteTagline" value="Dise√±o y automatizaci√≥n para tu negocio">
                </div>
            </div>
            <div class="form-group">
                <label for="siteDescription">Descripci√≥n</label>
                <textarea id="siteDescription">Impulsamos tu negocio con chatbots, sitios r√°pidos y presencia digital efectiva.</textarea>
            </div>
        </div>
        
        <!-- Informaci√≥n de Contacto -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-phone"></i>
                Informaci√≥n de Contacto
            </h2>
            <div class="grid">
                <div class="form-group">
                    <label for="phone">Tel√©fono / WhatsApp</label>
                    <input type="tel" id="phone" value="+502-3123-9807">
                </div>
                <div class="form-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email" id="email" value="contacto@botenginecorp.com">
                </div>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label for="instagram">Instagram</label>
                    <input type="text" id="instagram" value="botenginecorp">
                </div>
                <div class="form-group">
                    <label for="linkedin">LinkedIn</label>
                    <input type="text" id="linkedin" value="botenginecorp">
                </div>
            </div>
        </div>
        
        <!-- Servicios -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-cogs"></i>
                Servicios
            </h2>
            
            <div class="form-group">
                <label for="service1Title">Servicio 1 - T√≠tulo</label>
                <input type="text" id="service1Title" value="Chatbots inteligentes">
            </div>
            <div class="form-group">
                <label for="service1Desc">Servicio 1 - Descripci√≥n</label>
                <textarea id="service1Desc">Automatiza respuestas en WhatsApp, Instagram y web para atender a tus clientes 24/7.</textarea>
            </div>
            
            <div class="form-group">
                <label for="service2Title">Servicio 2 - T√≠tulo</label>
                <input type="text" id="service2Title" value="Dise√±o web moderno">
            </div>
            <div class="form-group">
                <label for="service2Desc">Servicio 2 - Descripci√≥n</label>
                <textarea id="service2Desc">Creamos sitios r√°pidos, seguros y optimizados para tu presencia digital.</textarea>
            </div>
            
            <div class="form-group">
                <label for="service3Title">Servicio 3 - T√≠tulo</label>
                <input type="text" id="service3Title" value="Automatizaci√≥n de procesos">
            </div>
            <div class="form-group">
                <label for="service3Desc">Servicio 3 - Descripci√≥n</label>
                <textarea id="service3Desc">Integramos herramientas para ahorrar tiempo en agendamiento, recordatorios y seguimiento.</textarea>
            </div>
        </div>
        </div>
        <!-- FIN TAB FRONTAL -->
        
        <!-- TAB TIENDA -->
        <div class="tab-content" id="tab-tienda">
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-box"></i>
                Gesti√≥n de Productos y Stock
            </h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> 
                Administra los productos y disponibilidad de tu tienda
            </p>
            
            <div style="margin-bottom: 30px;">
                <button class="btn btn-primary" id="addProductBtn" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Agregar Nuevo Producto
                </button>
            </div>
            
            <div id="productsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
        
        <!-- Pedidos -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-shopping-bag"></i>
                Historial de Pedidos
            </h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> 
                Todos los pedidos realizados en tu tienda
            </p>
            
            <div id="ordersList" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                <!-- Los pedidos se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
        
        <!-- Precios -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-dollar-sign"></i>
                Precios
            </h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> 
                Edita los rangos de precios para cada categor√≠a
            </p>
            
            <div class="price-item">
                <h4>Chatbots</h4>
                <div class="grid">
                    <div class="form-group">
                        <label for="chatbotBasic">B√°sico</label>
                        <input type="text" id="chatbotBasic" value="Q1,500 - Q2,500">
                    </div>
                    <div class="form-group">
                        <label for="chatbotIntermediate">Intermedio</label>
                        <input type="text" id="chatbotIntermediate" value="Q3,500 - Q5,000">
                    </div>
                    <div class="form-group">
                        <label for="chatbotAdvanced">Avanzado</label>
                        <input type="text" id="chatbotAdvanced" value="Q5,500 - Q7,000+">
                    </div>
                </div>
            </div>
            
            <div class="price-item">
                <h4>P√°ginas Web</h4>
                <div class="grid">
                    <div class="form-group">
                        <label for="webBasic">B√°sica</label>
                        <input type="text" id="webBasic" value="Q1,500 - Q2,500">
                    </div>
                    <div class="form-group">
                        <label for="webIntermediate">Intermedia</label>
                        <input type="text" id="webIntermediate" value="Q3,500 - Q5,000">
                    </div>
                    <div class="form-group">
                        <label for="webAdvanced">Avanzada</label>
                        <input type="text" id="webAdvanced" value="Q6,000 - Q8,000+">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="maintenance">Mantenimiento Mensual</label>
                <input type="text" id="maintenance" value="Q200">
            </div>
        </div>
        </div>
        <!-- FIN TAB TIENDA -->

        <!-- TAB CUPONES -->
        <div class="tab-content" id="tab-cupones">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 class="section-title">üéÅ Gesti√≥n de Cupones de Descuento</h2>
                    <button class="btn btn-primary" onclick="window.abrirModalCupon()">
                        <i class="fas fa-plus"></i> Nuevo Cup√≥n
                    </button>
                </div>

                <div id="couponsList">
                    <p style="color: #94a3b8; text-align: center;">Cargando cupones...</p>
                </div>
            </div>
        </div>
        <!-- FIN TAB CUPONES -->

        <!-- Modal Cupones -->
        <div id="couponModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: rgba(30, 41, 59, 0.95); border: 2px solid rgba(14, 165, 233, 0.3); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="couponModalTitle">Nuevo Cup√≥n</h3>
                    <button onclick="window.cerrarModalCupon()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                </div>

                <form id="couponForm" onsubmit="window.guardarCupon(event)">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>C√≥digo del Cup√≥n</label>
                        <input type="text" id="couponCode" placeholder="Ej: BIENVENIDA2026" required style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Descripci√≥n</label>
                        <input type="text" id="couponDescription" placeholder="Ej: Descuento de bienvenida 10%" style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Tipo de Descuento</label>
                            <select id="couponType" required style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                                <option value="percentage">Porcentaje (%)</option>
                                <option value="fixed">Cantidad Fija (Q)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Valor</label>
                            <input type="number" id="couponValue" placeholder="Ej: 10 o 50" step="0.01" required style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Compra M√≠nima (Q)</label>
                            <input type="number" id="couponMinPurchase" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                        </div>

                        <div class="form-group">
                            <label>Usos M√°ximos</label>
                            <input type="number" id="couponMaxUses" placeholder="Dejar vac√≠o para ilimitado" min="1" style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>V√°lido Hasta</label>
                        <input type="datetime-local" id="couponValidUntil" required style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.3); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; color: #f8fafc;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="couponActive" checked>
                            <span>Activo</span>
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Guardar Cup√≥n
                        </button>
                        <button type="button" onclick="window.cerrarModalCupon()" class="btn btn-secondary" style="flex: 1;">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script type="module">
      import { commerceAPI } from './js/commerce-api.js';
        // Funci√≥n para cambiar tabs
        function mostrarTab(tabName) {
            // Ocultar todos los tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Quitar clase active de botones
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Mostrar tab seleccionado
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Activar bot√≥n
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Event listeners para tabs
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                mostrarTab(tabName);
            });
        });

        // Event listener para cerrar modal
        document.querySelectorAll('[data-action="close-modal"]').forEach(btn => {
            btn.addEventListener('click', closeProductModal);
        });

        // Event listener para limpiar imagen
        document.querySelectorAll('[data-action="clear-image"]').forEach(btn => {
            btn.addEventListener('click', limpiarImagen);
        });

        // Variables globales
        let editingProductId = null;
        let currentImageBase64 = null;
        let adminToken = null;
        
        // Verificar autenticaci√≥n con JWT
        function checkAuthentication() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');
            
            if (!token || !user) {
                window.location.href = 'admin-login.html';
                return false;
            }
            
            adminToken = token;
            return true;
        }
        
        // Obtener headers con autenticaci√≥n
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            };
        }
        
        // Verificar autenticaci√≥n al cargar la p√°gina
        if (!checkAuthentication()) {
            throw new Error('No autorizado');
        }
        
        // Manejar carga de imagen
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentImageBase64 = event.target.result;
                    // Mostrar preview
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${currentImageBase64}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        });
        
        function limpiarImagen() {
            currentImageBase64 = null;
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').innerHTML = 'Preview de la imagen';
        }
        
        // Cargar datos guardados
        function loadData() {
            const savedData = localStorage.getItem('adminData');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = data[key];
                    }
                });
            }
            loadProducts();
        }
        
        // Cargar productos
        async function loadProducts() {
            try {
                const products = await commerceAPI.getProducts();
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = '';
                
                if (products.length === 0) {
                    productsList.innerHTML = '<p style="color: #94a3b8; text-align: center; grid-column: 1/-1;">No hay productos agregados a√∫n</p>';
                    return;
                }
                
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    const imageHtml = product.image 
                        ? `<img src="${product.image}" alt="${product.name}">` 
                        : '<i class="fas fa-box" style="font-size: 3rem; color: #667eea;"></i>';
                
                    // Badge de estado
                    const statusColor = product.status === 'activo' ? '#10b981' : product.status === 'agotado' ? '#ef4444' : '#94a3b8';
                    const statusText = product.status === 'activo' ? '‚úì Activo' : product.status === 'agotado' ? 'Agotado' : 'Inactivo';
                
                productCard.innerHTML = `
                    <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        ${statusText}
                    </div>
                    <div class="product-card-header">
                        <div class="product-card-image">
                            ${imageHtml}
                        </div>
                        <div>
                            <h3 style="color: #f8fafc; margin-bottom: 5px;">${product.name}</h3>
                            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px;">
                                <i class="fas fa-tag"></i> ${product.category}
                            </p>
                            <p style="color: #cbd5e1; font-size: 0.9rem; line-height: 1.4;">${product.description}</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">Precio Venta:</span><br>
                                <span style="color: #10b981; font-weight: bold; font-size: 1rem;">Q ${parseFloat(product.price).toFixed(2)}</span>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">Costo:</span><br>
                                <span style="color: #94a3b8; font-weight: bold; font-size: 1rem;">Q ${parseFloat(product.cost || 0).toFixed(2)}</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; padding: 12px; background: rgba(14, 165, 233, 0.1); border-radius: 6px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">Stock:</span><br>
                                <span style="color: ${product.stock > 10 ? '#0ea5e9' : product.stock > 0 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">
                                    ${product.stock} unidades
                                </span>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">Ventas:</span><br>
                                <span style="color: #0ea5e9; font-weight: bold;">
                                    ${product.sales || 0} unidades
                                </span>
                            </div>
                        </div>
                        <div class="product-card-actions">
                            <button class="btn btn-primary" data-action="edit-product" data-product-id="${product.id}" style="padding: 10px 16px; font-size: 0.85rem; flex: 1;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-delete" data-action="delete-product" data-product-id="${product.id}" style="padding: 10px 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                    productCard.style.position = 'relative';
                productsList.appendChild(productCard);
                });

                // Agregar event listeners a los botones din√°micos
                productsList.querySelectorAll('[data-action="edit-product"]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = parseInt(this.getAttribute('data-product-id'));
                        editProduct(productId);
                    });
                });

                productsList.querySelectorAll('[data-action="delete-product"]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = parseInt(this.getAttribute('data-product-id'));
                        deleteProduct(productId);
                    });
                });
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }
        
        // Cargar pedidos
        async function loadOrders() {
            try {
                const orders = await commerceAPI.getOrders();
            const ordersList = document.getElementById('ordersList');
            
            if (!ordersList) return;
            
            ordersList.innerHTML = '';
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p style="color: #94a3b8; text-align: center;">No hay pedidos a√∫n</p>';
                return;
            }
            
            orders.reverse().forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                const itemsHTML = order.items.map(item => {
                  const subtotal = parseFloat(item.subtotal) || 0;
                  return `
                    <div class="order-item">
                        <span>${item.nombre} (x${item.cantidad})</span>
                        <span>Q ${subtotal.toFixed(2)}</span>
                    </div>
                  `;
                }).join('');
                
                const total = parseFloat(order.total) || 0;
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div>
                            <div class="order-email"><i class="fas fa-envelope"></i> ${order.email}</div>
                            <div class="order-date"><i class="fas fa-clock"></i> ${order.fecha}</div>
                        </div>
                        <div class="order-total">Q ${total.toFixed(2)}</div>
                    </div>
                    <div class="order-items">
                        ${itemsHTML}
                    </div>
                `;
                
                ordersList.appendChild(orderCard);
            });
            } catch (error) {
                console.error('Error cargando pedidos:', error);
            }
        }

        // ===== CUPONES =====
        let editingCouponId = null;

        // Cargar cupones
        window.loadCoupons = async function loadCoupons() {
            try {
                const response = await fetch('/api/commerce/coupons', {
                    headers: getAuthHeaders()
                });
                const coupons = await response.json();
                const couponsList = document.getElementById('couponsList');
                couponsList.innerHTML = '';

                if (!coupons || coupons.length === 0) {
                    couponsList.innerHTML = '<p style="color: #94a3b8; text-align: center;">No hay cupones creados a√∫n</p>';
                    return;
                }

                coupons.forEach(coupon => {
                    const expirado = new Date(coupon.valid_until) < new Date();
                    const couponCard = document.createElement('div');
                    couponCard.style.cssText = 'background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(14, 165, 233, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;';
                    
                    const tipoDescuento = coupon.discount_type === 'percentage' ? '%' : 'Q';
                    couponCard.innerHTML = `
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                <span style="background: rgba(14, 165, 233, 0.2); color: #0ea5e9; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 1.1rem;">${coupon.code}</span>
                                <span style="color: #10b981; font-weight: 600;">-${coupon.discount_value}${tipoDescuento}</span>
                                ${coupon.is_active ? '<span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Activo</span>' : '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Inactivo</span>'}
                                ${expirado ? '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Expirado</span>' : ''}
                            </div>
                            <p style="color: #cbd5e1; margin-bottom: 8px;">${coupon.description || 'Sin descripci√≥n'}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.85rem;">
                                <div style="color: #94a3b8;">Min. compra: <span style="color: #f8fafc;">Q ${coupon.min_purchase || 0}</span></div>
                                <div style="color: #94a3b8;">Usos: <span style="color: #f8fafc;">${coupon.current_uses}${coupon.max_uses ? '/' + coupon.max_uses : '/‚àû'}</span></div>
                                <div style="color: #94a3b8;">V√°lido hasta: <span style="color: #f8fafc;">${new Date(coupon.valid_until).toLocaleDateString('es-ES')}</span></div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 15px;">
                            <button onclick="window.editarCupon(${coupon.id})" class="btn btn-primary" style="padding: 8px 12px; font-size: 0.85rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.eliminarCupon(${coupon.id})" class="btn-delete" style="padding: 8px 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    couponsList.appendChild(couponCard);
                });
            } catch (error) {
                console.error('Error cargando cupones:', error);
            }
        }

        // Abrir modal cup√≥n
        window.abrirModalCupon = function() {
            editingCouponId = null;
            document.getElementById('couponModalTitle').textContent = 'Nuevo Cup√≥n';
            document.getElementById('couponForm').reset();
            document.getElementById('couponActive').checked = true;
            document.getElementById('couponModal').style.display = 'flex';
        }

        // Cerrar modal cup√≥n
        window.cerrarModalCupon = function() {
            document.getElementById('couponModal').style.display = 'none';
        }

        // Editar cup√≥n
        window.editarCupon = async function(couponId) {
            try {
                const response = await fetch('/api/commerce/coupons', {
                    headers: getAuthHeaders()
                });
                const coupons = await response.json();
                const coupon = coupons.find(c => c.id === couponId);

                if (!coupon) return;

                editingCouponId = couponId;
                document.getElementById('couponModalTitle').textContent = 'Editar Cup√≥n';
                document.getElementById('couponCode').value = coupon.code;
                document.getElementById('couponDescription').value = coupon.description || '';
                document.getElementById('couponType').value = coupon.discount_type;
                document.getElementById('couponValue').value = coupon.discount_value;
                document.getElementById('couponMinPurchase').value = coupon.min_purchase || 0;
                document.getElementById('couponMaxUses').value = coupon.max_uses || '';
                document.getElementById('couponActive').checked = coupon.is_active;

                // Convertir a datetime-local
                const date = new Date(coupon.valid_until);
                document.getElementById('couponValidUntil').value = date.toISOString().slice(0, 16);

                document.getElementById('couponModal').style.display = 'flex';
            } catch (error) {
                console.error('Error editando cup√≥n:', error);
            }
        }

        // Guardar cup√≥n
        window.guardarCupon = async function(event) {
            event.preventDefault();

            const couponData = {
                code: document.getElementById('couponCode').value.toUpperCase(),
                description: document.getElementById('couponDescription').value,
                discount_type: document.getElementById('couponType').value,
                discount_value: parseFloat(document.getElementById('couponValue').value),
                min_purchase: parseFloat(document.getElementById('couponMinPurchase').value) || 0,
                max_uses: document.getElementById('couponMaxUses').value ? parseInt(document.getElementById('couponMaxUses').value) : null,
                valid_until: document.getElementById('couponValidUntil').value,
                is_active: document.getElementById('couponActive').checked
            };

            try {
                const url = editingCouponId ? `/api/commerce/coupons/${editingCouponId}` : '/api/commerce/coupons';
                const method = editingCouponId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(couponData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'No se pudo guardar el cup√≥n'));
                    return;
                }

                alert(editingCouponId ? 'Cup√≥n actualizado' : 'Cup√≥n creado');
                window.cerrarModalCupon();
                window.loadCoupons();
            } catch (error) {
                console.error('Error guardando cup√≥n:', error);
                alert('Error al guardar el cup√≥n');
            }
        }

        // Eliminar cup√≥n
        window.eliminarCupon = async function(couponId) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este cup√≥n?')) return;

            try {
                const response = await fetch(`/api/commerce/coupons/${couponId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    alert('Error al eliminar el cup√≥n');
                    return;
                }

                alert('Cup√≥n eliminado');
                window.loadCoupons();
            } catch (error) {
                console.error('Error eliminando cup√≥n:', error);
                alert('Error al eliminar el cup√≥n');
            }
        }
        
        // Abrir modal para nuevo producto
        document.getElementById('addProductBtn').addEventListener('click', () => {
            editingProductId = null;
            currentImageBase64 = null;
            document.getElementById('modalTitle').textContent = 'Nuevo Producto';
            document.getElementById('productForm').reset();
            document.getElementById('productStatus').value = 'activo';
            document.getElementById('productMargin').value = 50;
            document.getElementById('imagePreview').innerHTML = 'Preview de la imagen';
            document.getElementById('productModal').classList.add('active');
        });
        
        // Cerrar modal
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = 'Preview de la imagen';
            editingProductId = null;
            currentImageBase64 = null;
        }
        
        // Editar producto
        async function editProduct(id) {
            try {
                const products = await commerceAPI.getProducts();
                const product = products.find(p => p.id === id);
                
                if (product) {
                    editingProductId = id;
                    currentImageBase64 = product.image || null;
                document.getElementById('modalTitle').textContent = 'Editar Producto';
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCost').value = product.cost || 0;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productStatus').value = product.status || 'activo';
                document.getElementById('productMargin').value = product.margin || 50;
                document.getElementById('productImage').value = '';
                
                // Mostrar preview si existe imagen
                if (product.image) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${product.image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
                } else {
                    document.getElementById('imagePreview').innerHTML = 'Preview de la imagen';
                }
                
                document.getElementById('productModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error editando producto:', error);
            }
        }
        
        // Eliminar producto
        async function deleteProduct(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
                try {
                    await commerceAPI.deleteProduct(id);
                loadProducts();
                } catch (error) {
                    console.error('Error eliminando producto:', error);
                    alert('Error eliminando producto');
                }
            }
        }
        
        // ===== CALCULADORA DE PRECIOS =====
        function actualizarCalculadora() {
            const costInput = document.getElementById('productCost');
            const marginInput = document.getElementById('productMargin');
            const priceInput = document.getElementById('productPrice');
            
            const costo = parseFloat(costInput.value) || 0;
            const margen = parseInt(marginInput.value) || 50;
            
            if (costo > 0) {
                const ganancia = (costo * margen) / 100;
                const precioVenta = costo + ganancia;
                const margenReal = (ganancia / precioVenta * 100).toFixed(1);
                
                document.getElementById('gananciaDisplay').textContent = `Q ${ganancia.toFixed(2)}`;
                document.getElementById('margenRealDisplay').textContent = `${margenReal}%`;
                document.getElementById('precioRecomendado').textContent = `Q ${precioVenta.toFixed(2)}`;
                document.getElementById('gananciaTotal').textContent = `Q ${ganancia.toFixed(2)}`;
                
                // Auto-llenar el precio de venta
                priceInput.value = precioVenta.toFixed(2);
            }
        }
        
        // Event listeners para calculadora
        document.getElementById('productCost').addEventListener('input', actualizarCalculadora);
        document.getElementById('productMargin').addEventListener('input', actualizarCalculadora);
        
        // Botones para agregar costos al precio final
        document.getElementById('btnAgregarPaggo').addEventListener('click', (e) => {
            e.preventDefault();
            const priceInput = document.getElementById('productPrice');
            const precioActual = parseFloat(priceInput.value) || 0;
            if (precioActual > 0) {
                const comision = precioActual * 0.0483;
                const nuevoPrecio = precioActual + comision;
                priceInput.value = nuevoPrecio.toFixed(2);
            }
        });
        
        document.getElementById('btnAgregarEnvio').addEventListener('click', (e) => {
            e.preventDefault();
            const priceInput = document.getElementById('productPrice');
            const precioActual = parseFloat(priceInput.value) || 0;
            const nuevoPrecio = precioActual + 15;
            priceInput.value = nuevoPrecio.toFixed(2);
        });
        
        // Botones de margen r√°pido
        document.querySelectorAll('.margin-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const margin = btn.getAttribute('data-margin');
                document.getElementById('productMargin').value = margin;
                document.querySelectorAll('.margin-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                actualizarCalculadora();
            });
        });
        
        // Guardar producto
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentImageBase64 && !editingProductId) {
                alert('Por favor selecciona una imagen para el producto');
                return;
            }
            
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image: currentImageBase64,
                category: document.getElementById('productCategory').value,
                cost: parseFloat(document.getElementById('productCost').value),
                margin: parseInt(document.getElementById('productMargin').value) || 50,
                status: document.getElementById('productStatus').value || 'activo'
            };
            
            try {
                if (editingProductId) {
                    await commerceAPI.updateProduct(editingProductId, productData);
                } else {
                    await commerceAPI.createProduct(productData);
                }
                
                closeProductModal();
                await loadProducts();
                showNotification();
            } catch (error) {
                console.error('Error guardando producto:', error);
                alert('Error guardando producto');
            }
        });
        
        // Guardar datos general
        function saveData() {
            const data = {};
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea');
            inputs.forEach(input => {
                if (input.id && !input.id.startsWith('product')) {
                    data[input.id] = input.value;
                }
            });
            
            localStorage.setItem('adminData', JSON.stringify(data));
            showNotification();
        }
        
        // Mostrar notificaci√≥n
        function showNotification() {
            const notification = document.getElementById('saveNotification');
            notification.style.display = 'flex';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Event listeners
        document.getElementById('saveAllBtn').addEventListener('click', saveData);
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                // Limpiar JWT y datos de usuario de localStorage
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                localStorage.removeItem('adminTokenExpiry');
                // Limpiar token del API
                commerceAPI.token = null;
                // Redirigir al login
                window.location.href = 'admin-login.html';
            }
        });
        
        // NO cerrar modal al hacer click fuera - solo con bot√≥n de cerrar
        // Modal se cierra solo con el bot√≥n X
        
        // Cargar datos al iniciar
        loadData();
        loadOrders();
        window.loadCoupons();
        
        // Auto-guardar cada 30 segundos
        setInterval(() => {
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea');
            let hasChanges = false;
            
            inputs.forEach(input => {
                if (input.dataset.originalValue !== input.value) {
                    hasChanges = true;
                }
            });
            
            if (hasChanges) {
                saveData();
            }
        }, 30000);
        
        // Guardar valores originales para detectar cambios
        window.addEventListener('load', () => {
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.dataset.originalValue = input.value;
            });
        });
    </script>
</body>
</html>
